@page
@model RenderChatModel
@{
    ViewData["Title"] = "Render Server Chat";
}

<h2>Render Server Chatroom</h2>

<div id="connectionStatus" style="margin-bottom:10px; padding:10px; background-color:#e3f2fd; border-radius:4px;">
    <strong>Status:</strong> <span id="status">Connecting...</span>
</div>

<div id="messages" style="border:1px solid #ccc;height:400px;overflow-y:scroll;padding:10px; background-color:#f9f9f9; border-radius:4px;"></div>

<div style="margin-top:10px;">
    <input type="text" id="message" placeholder="Type your message..." style="width:80%; padding:8px; border:1px solid #ccc; border-radius:4px;" />
    <button id="sendBtn" style="padding:8px 20px; background-color:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Send</button>
</div>

@section Scripts {
    @{
        var userName = Environment.UserName;
    }
    <script>
        let ws;
        const userName = "@userName";
        const messagesDiv = document.getElementById("messages");
        const statusSpan = document.getElementById("status");
        const messageInput = document.getElementById("message");
        const sendBtn = document.getElementById("sendBtn");

        function connectWebSocket() {
            ws = new WebSocket("wss://tiny-render-server.onrender.com");

            ws.onopen = function() {
                console.log("WebSocket Connected");
                statusSpan.textContent = "Connected";
                statusSpan.style.color = "green";
                sendBtn.disabled = false;
            };


            // Cere permisiunea la încărcare
            if ("Notification" in window) {
                Notification.requestPermission().then(permission => {
                    console.log("Notification permission:", permission);
                });
            }

            ws.onmessage = function(event) {
                try {
                    const msgObj = JSON.parse(event.data);

                    const msgElement = document.createElement("div");
                    msgElement.style.marginBottom = "8px";

                    msgElement.innerHTML = `<strong>${msgObj.user}</strong>: ${msgObj.message}
                        <span style="color:gray;font-size:0.85em; float:right;">${new Date().toLocaleString()}</span>`;

                    messagesDiv.appendChild(msgElement);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;

                    // Notificare dacă tab-ul nu e activ
                    if (Notification.permission === "granted" && document.hidden) {
                        new Notification(msgObj.user, {
                            body: msgObj.message,
                            icon: "/chat-icon.png" // optional
                        });
                    }
                } catch (e) {
                    const msgElement = document.createElement("div");
                    msgElement.textContent = event.data;
                    messagesDiv.appendChild(msgElement);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            };

            ws.onerror = function(error) {
                console.error("WebSocket Error:", error);
                statusSpan.textContent = "Error";
                statusSpan.style.color = "red";
            };

            ws.onclose = function() {
                console.log("WebSocket Disconnected");
                statusSpan.textContent = "Disconnected";
                statusSpan.style.color = "red";
                sendBtn.disabled = true;

                setTimeout(() => {
                    statusSpan.textContent = "Reconnecting...";
                    statusSpan.style.color = "orange";
                    connectWebSocket();
                }, 3000);
            };
        }

        connectWebSocket();

        sendBtn.addEventListener("click", () => sendMessage());
        messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
        });

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message === "") return;

            if (ws && ws.readyState === WebSocket.OPEN) {
                const msgObj = {
                    type: "chat",
                    user: userName,
                    message: message
                };
                ws.send(JSON.stringify(msgObj));
                messageInput.value = "";
            } else {
                alert("WebSocket is not connected. Please wait...");
            }
        }

        sendBtn.disabled = true;
    </script>
}
